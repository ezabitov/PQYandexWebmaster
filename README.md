#Сбор популярных запросов из Яндекс.Вебмастер в Power BI

Функция работает только в __Power BI__, т.к. Excel не поддерживает запуск R-скриптов.

Через API Яндекс.Вебмастер забирает топ-500 запросов по всем сайтам из аккаунта и собирает их в одну таблицу.

Внутри встроен R-скрипт, который сохраняет полученный в результате срабатывания функции датасет в .txt файл.

###Что умеет
1. Вытаскивает топ-500 запросов из Яндекс.Вебмастер по всем доменам заведенным в аккаунте.
2. Складывает их в .txt документ с разделителем табуляции с указанием домена и периода.
###Что не умеет
1. Вытаскивать запросы по конкретному домену. Если будут такие запросы — сделаю.
2. Обрабатывать конечный текстовый файл.

##Как использовать
1. Получаем токен по [ссылке](https://oauth.yandex.ru/authorize?response_type=token&client_id=f08ac1790cc9409aa328b3eda091d105);
2. Скачиваем [R](https://cran.r-project.org/bin/windows/base/), [R-Studio](https://www.rstudio.com/products/rstudio/download/), [ActivePerl](https://www.activestate.com/activeperl/downloads), если их еще нет. Все устанавливаем;
3. Заходим в R-Studio и устанавливаем package «gdata»;
4. Создаем пустой запрос в PowerBI и вставляем код в расширенный редактор ([Подробнее в блоге](http://zabitov.ru/analitika/yandex-direct-power-query-connector/));
5. Заменяем «C:/Users/User/Desktop/1111.txt» на свой путь и имя файла. Разрешение оставляем .txt.
6. Вводим полученный токен и параметр, по которому формируется топ запросов:
>«TOTAL_SHOWS» → если нужен топ-500 запросов по показам
«TOTAL_CLICKS» → если нужен топ-500 запросов по кликам

7. Список запросов сохранен в файле :)
8. Если хотим посмотреть на сам список запросов, то заменяем в самом конце функции
```
in
    R
in
searchQueries
```
на
```
in
    changeType
in
searchQueries
```
Функция перестанет записывать запросы в файл, но начнет их отображать.
Теперь раз в неделю, достаточно открывать функцию и нажимать «обновить».

##Важно
Каждый раз, после обновления запроса, он будет дописывать в текстовый файл все свое содержимое. Как вариант решения проблемы, при обработке конечного файла, можно сцепить наименование запроса и период, после чего почистить дубли по этому столбцу.

[Инструкция со скринами в блоге](http://zabitov.ru/analitika/avtomaticheskiy-sbor-zaprosov-iz-yandex-webmaster/)
